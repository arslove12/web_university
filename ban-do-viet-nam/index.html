<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bản đồ Việt Nam (Hiển thị tên tỉnh khi rê chuột)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100%; }
    .province-label {
      background-color: rgba(255, 255, 255, 0.9);
      border: 1px solid #ccc;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      color: #333;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 14px;
      padding: 6px 10px;
      text-align: center;
      white-space: nowrap;
      transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
      opacity: 0;
      transform: translateY(10px);
      pointer-events: none; /* Ignore mouse events on the label itself */
    }

    .province-label-visible {
      opacity: 1;
      transform: translateY(0);
    }

    #close-button {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000; /* Ensure it's on top */
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
      font-family: Arial, sans-serif;
      font-size: 16px;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="close-button" class="hidden">&times;</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map', {
      zoomControl: false,
      attributionControl: false
    });

    const VN_CENTER = [16.0, 107.5];
    let allProvincesLayer = null;
    let detailedLayer = null;
    const closeButton = document.getElementById('close-button');

    map.setView(VN_CENTER, 6);

    function getRandomPastelColor() {
      const r = Math.round((Math.random() * 127) + 127);
      const g = Math.round((Math.random() * 127) + 127);
      const b = Math.round((Math.random() * 127) + 127);
      return `rgb(${r},${g},${b})`;
    }

    const onEachFeature = (feature, layer) => {
      const name = feature.properties.ten_tinh || "Không rõ";
      let label = null;
      let timeoutId = null;

      layer.on('mouseover', function (e) {
        layer.setStyle({ weight: 2, color: "#000" });
        if (timeoutId) clearTimeout(timeoutId);

        const center = layer.getBounds().getCenter();
        if (!label) {
            label = L.marker(center, {
                icon: L.divIcon({ className: 'province-label', html: name }),
                interactive: false
            }).addTo(map);
        }
        setTimeout(() => { if (label) label.getElement().classList.add('province-label-visible'); }, 10);
      });

      layer.on('mouseout', function (e) {
        layer.setStyle({ weight: 1, color: "#555" });
        if (label) {
          label.getElement().classList.remove('province-label-visible');
          timeoutId = setTimeout(() => { if (label) { map.removeLayer(label); label = null; } }, 200);
        }
      });
    };

    const onEachFeatureDetail = (feature, layer) => {
        const name = feature.properties.ten_xa || "Không rõ";
        let label = null;
        let timeoutId = null;

        layer.on('mouseover', function (e) {
            layer.setStyle({ weight: 2, color: '#000' });
            if (timeoutId) clearTimeout(timeoutId);

            const center = layer.getBounds().getCenter();
            if (!label) {
                label = L.marker(center, {
                    icon: L.divIcon({ className: 'province-label', html: name }),
                    interactive: false
                }).addTo(map);
            }
            setTimeout(() => { if (label) label.getElement().classList.add('province-label-visible'); }, 10);
        });

        layer.on('mouseout', function (e) {
            layer.setStyle({ weight: 1, color: '#555' });
            if (label) {
                label.getElement().classList.remove('province-label-visible');
                timeoutId = setTimeout(() => { if (label) { map.removeLayer(label); label = null; } }, 200);
            }
        });
    };

    const provinceFiles = [
      "An Giang.geojson", "Bắc Ninh.geojson", "Cà Mau.geojson", "Cần Thơ.geojson", "Cao Bằng.geojson",
      "Đà Nẵng.geojson", "Đắk Lắk.geojson", "Điện Biên.geojson", "Đồng Nai.geojson", "Đồng Tháp.geojson",
      "Gia Lai .geojson", "Hà Nội.geojson", "Hà Tĩnh.geojson", "Hải Phòng.geojson", "Huế .geojson",
      "Hưng Yên.geojson", "Khánh Hòa.geojson", "Lai Châu.geojson", "Lâm Đồng.geojson", "Lạng Sơn.geojson",
      "Lào Cai.geojson", "Nghệ An.geojson", "Ninh Bình.geojson", "Phú Thọ.geojson", "Quảng Ngãi.geojson",
      "Quảng Ninh.geojson", "Quảng Trị.geojson", "Sơn La.geojson", "Tây Ninh.geojson", "Thái Nguyên.geojson",
      "Thanh Hóa.geojson", "TP. Hồ Chí Minh.geojson", "Tuyên Quang.geojson", "Vĩnh Long.geojson"
    ];

    Promise.all(provinceFiles.map(file => fetch(file).then(res => res.json())))
      .then(allGeoJSONs => {
        allProvincesLayer = L.featureGroup();
        allGeoJSONs.forEach(geojson => {
          const provinceLayer = L.geoJSON(geojson, {
            style: () => ({ color: "#555", weight: 1, fillColor: getRandomPastelColor(), fillOpacity: 0.7 }),
            onEachFeature: onEachFeature
          });
          allProvincesLayer.addLayer(provinceLayer);
        });
        allProvincesLayer.addTo(map);
        map.fitBounds(allProvincesLayer.getBounds());
        map.setMaxBounds(allProvincesLayer.getBounds());
      });

    const cities = [
      { name: "Hà Nội", coords: [21.0285, 105.8542], file: "Hà Nội (phường xã) - 34.geojson" },
      { name: "Hải Phòng", coords: [20.8449, 106.6881], file: "Hải Phòng (phường xã) - 34.geojson" },
      { name: "Thanh Hóa", coords: [19.8075, 105.7769], file: "Thanh Hóa (phường xã) - 34.geojson" }
    ];

    cities.forEach(city => {
      L.marker(city.coords).addTo(map).on('click', () => {
        fetch(city.file)
          .then(res => {
            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
          })
          .then(geojson => {
            if (allProvincesLayer) map.removeLayer(allProvincesLayer);
            if (detailedLayer) map.removeLayer(detailedLayer);

            detailedLayer = L.geoJSON(geojson, {
              style: () => ({ color: "#555", weight: 1, fillColor: getRandomPastelColor(), fillOpacity: 0.7 }),
              onEachFeature: onEachFeatureDetail
            }).addTo(map);

            map.fitBounds(detailedLayer.getBounds());
            map.setMaxBounds(null); // Allow free panning in detailed view
            closeButton.classList.remove('hidden');
          })
          .catch(e => {
            console.error('Error loading detailed map:', e);
            alert('Đã có lỗi xảy ra khi tải bản đồ chi tiết. Vui lòng kiểm tra lại tên tệp và đường dẫn.');
          });
      });
    });

    closeButton.addEventListener('click', () => {
      if (detailedLayer) map.removeLayer(detailedLayer);
      if (allProvincesLayer) allProvincesLayer.addTo(map);
      
      detailedLayer = null;
      map.fitBounds(allProvincesLayer.getBounds());
      map.setMaxBounds(allProvincesLayer.getBounds());
      closeButton.classList.add('hidden');
    });
  </script>
</body>
</html>