<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bản đồ Việt Nam</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    #map { width: 100%; height: 100%; background-color: #FAF0E6; }
    .province-label {
      background-color: transparent;
      border: none;
      box-shadow: none;
      color: #5C4033; /* Dark Brown */
      font-family: 'Georgia', serif;
      font-size: 16px;
      font-weight: bold;
      text-align: center;
      white-space: nowrap;
      transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
      opacity: 0;
      transform: translateY(10px);
      pointer-events: none;
      text-shadow: -1px -1px 0 #FAF0E6, 1px -1px 0 #FAF0E6, -1px 1px 0 #FAF0E6, 1px 1px 0 #FAF0E6, -2px 0 3px rgba(0,0,0,0.2);
    }

    .province-label-visible {
      opacity: 1;
      transform: translateY(0);
    }

    #close-button {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1001;
      background: white;
      border: 2px solid rgba(0,0,0,0.2);
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 16px;
    }

    .hidden {
      display: none;
    }
    
    .map-title {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1001;
        background: rgba(250, 240, 230, 0.8);
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 1.5em;
        font-weight: bold;
        font-family: 'Georgia', serif;
        color: #5C4033;
        border: 1px solid #8B4513;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="map-title">Bản đồ Việt Nam</div>
  <div id="close-button" class="hidden">&times;</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map', {
      zoomControl: false,
      attributionControl: false
    });

    const VN_CENTER = [16.0, 107.5];
    let allProvincesLayer = null;
    let detailedLayer = null;
    const closeButton = document.getElementById('close-button');

    map.setView(VN_CENTER, 6);

    const vintageColors = [
        '#D2B48C', '#A0522D', '#8B4513', '#BC8F8F', '#F5DEB3', '#6B8E23', '#708090', '#BDB76B', '#CD853F', '#D8BFD8', '#556B2F', '#9370DB', '#F0E68C', '#C0C0C0', '#8FBC8F'
    ];
    let colorIndex = 0;

    function getNextVintageColor() {
        const color = vintageColors[colorIndex];
        colorIndex = (colorIndex + 1) % vintageColors.length;
        return color;
    }

    const defaultStyle = {
        weight: 1,
        color: '#444',
        fillOpacity: 0.75,
    };

    const highlightStyle = {
        weight: 2.5,
        color: '#000',
        fillOpacity: 0.9,
    };

    const onEachFeature = (feature, layer) => {
      const name = feature.properties.ten_tinh || "Không rõ";
      let label = null;
      let timeoutId = null;

      layer.on('mouseover', function (e) {
        layer.setStyle(highlightStyle);
        if (timeoutId) clearTimeout(timeoutId);

        const center = layer.getBounds().getCenter();
        if (!label) {
            label = L.marker(center, {
                icon: L.divIcon({ className: 'province-label', html: name }),
                interactive: false
            }).addTo(map);
        }
        setTimeout(() => { if (label) label.getElement().classList.add('province-label-visible'); }, 10);
      });

      layer.on('mouseout', function (e) {
        layer.setStyle({...defaultStyle, fillColor: layer.options.fillColor});
        if (label) {
          label.getElement().classList.remove('province-label-visible');
          timeoutId = setTimeout(() => { if (label) { map.removeLayer(label); label = null; } }, 200);
        }
      });
    };

    const onEachFeatureDetail = (feature, layer) => {
        const name = feature.properties.ten_xa || "Không rõ";
        let label = null;
        let timeoutId = null;

        layer.on('mouseover', function (e) {
            layer.setStyle(highlightStyle);
            if (timeoutId) clearTimeout(timeoutId);

            const center = layer.getBounds().getCenter();
            if (!label) {
                label = L.marker(center, {
                    icon: L.divIcon({ className: 'province-label', html: name }),
                    interactive: false
                }).addTo(map);
            }
            setTimeout(() => { if (label) label.getElement().classList.add('province-label-visible'); }, 10);
        });

        layer.on('mouseout', function (e) {
            layer.setStyle({...defaultStyle, fillColor: layer.options.fillColor});
            if (label) {
                label.getElement().classList.remove('province-label-visible');
                timeoutId = setTimeout(() => { if (label) { map.removeLayer(label); label = null; } }, 200);
            }
        });
    };

    const provinceFiles = ['provinces_part1.geojson', 'provinces_part2.geojson', 'provinces_part3.geojson', 'provinces_part4.geojson'];

    Promise.all(provinceFiles.map(file => fetch(file).then(res => res.json())))
      .then(allGeoJSONs => {
        const allFeatures = allGeoJSONs.flatMap(geojson => geojson.features);
        const combinedGeoJSON = { type: "FeatureCollection", features: allFeatures };

        allProvincesLayer = L.geoJSON(combinedGeoJSON, {
            style: (feature) => ({
                ...defaultStyle,
                fillColor: getNextVintageColor()
            }),
            onEachFeature: onEachFeature
        });

        // Manually assign and store the color for each layer
        let tempColorIndex = 0;
        allProvincesLayer.eachLayer(layer => {
            const color = vintageColors[tempColorIndex % vintageColors.length];
            layer.setStyle({fillColor: color});
            layer.options.fillColor = color; // Store color for mouseout
            tempColorIndex++;
        });

        allProvincesLayer.addTo(map);
        map.fitBounds(allProvincesLayer.getBounds());
        map.setMaxBounds(allProvincesLayer.getBounds());
      });

    const cities = [
      { name: "Hà Nội", coords: [21.0285, 105.8542], file: "Hà Nội (phường xã) - 34.geojson" },
      { name: "Hải Phòng", coords: [20.8449, 106.6881], file: "Hải Phòng (phường xã) - 34.geojson" },
      { name: "Thanh Hóa", coords: [19.8075, 105.7769], file: "Thanh Hóa (phường xã) - 34.geojson" }
    ];

    const cityMarkers = [];
    const detailMarkersLayer = L.featureGroup().addTo(map);

    cities.forEach(city => {
      const marker = L.marker(city.coords).addTo(map);
      marker.on('click', () => {
        cityMarkers.forEach(m => map.removeLayer(m));
        if (allProvincesLayer) map.removeLayer(allProvincesLayer);

        fetch(city.file)
          .then(res => res.ok ? res.json() : Promise.reject(res.status))
          .then(geojson => {
            detailedLayer = L.geoJSON(geojson, {
              style: () => ({...defaultStyle, fillColor: getNextVintageColor()}),
              onEachFeature: onEachFeatureDetail
            }).addTo(map);

            map.fitBounds(detailedLayer.getBounds());

            const locationDetails = {
              "Hoàn Kiếm": {
                image: "hangga.jpg",
                content: "Giữa lòng Hà Nội cổ kính, thuốc lào Hàng Gà mang hơi thở của thủ đô xưa. Một hơi Hàng Gà như bước chân vào con ngõ rêu phong. Khói êm ái, vị ngọt hậu như hạt đậu rang, gợi nhớ tiếng rao đêm, ánh đèn vàng, và nhịp sống chậm rãi. Nó là món quà dành cho những tâm hồn hoài cổ, muốn tìm lại ký ức Hà Nội trong từng làn khói"
              },
              "Vĩnh Bảo": { image: "https://via.placeholder.com/150", content: "Vĩnh Bảo là một huyện ngoại thành của thành phố Hải Phòng." },
              "Tiên Lãng": { image: "https://via.placeholder.com/150", content: "Tiên Lãng là một huyện ven biển của thành phố Hải Phòng." },
              "Quảng Xương": { image: "https://via.placeholder.com/150", content: "Quảng Xương là một huyện ven biển thuộc tỉnh Thanh Hóa." },
              "Nga Sơn": { image: "https://via.placeholder.com/150", content: "Nga Sơn là một huyện ven biển nằm ở phía đông bắc tỉnh Thanh Hóa." },
              "Hoằng Hóa": { image: "https://via.placeholder.com/150", content: "Hoằng Hóa là một huyện đồng bằng ven biển thuộc tỉnh Thanh Hóa." }
            };

            const createPopupContent = (details) => {
              return `<div style="width: 200px;">
                        <img src="${details.image}" alt="Hình ảnh" style="width:100%; height:auto; border-radius: 4px;">
                        <p style="margin-top: 10px;">${details.content}</p>
                      </div>`;
            };

            if (city.name === "Hà Nội") {
                const details = locationDetails["Hoàn Kiếm"];
                const popupContent = createPopupContent(details);
                L.marker([21.0285, 105.8542]).bindPopup(popupContent).addTo(detailMarkersLayer);
            } else if (city.name === "Hải Phòng") {
                let details = locationDetails["Vĩnh Bảo"];
                let popupContent = createPopupContent(details);
                L.marker([20.689, 106.479]).bindPopup(popupContent).addTo(detailMarkersLayer);

                details = locationDetails["Tiên Lãng"];
                popupContent = createPopupContent(details);
                L.marker([20.731, 106.560]).bindPopup(popupContent).addTo(detailMarkersLayer);
            } else if (city.name === "Thanh Hóa") {
                let details = locationDetails["Quảng Xương"];
                let popupContent = createPopupContent(details);
                L.marker([19.681, 105.800]).bindPopup(popupContent).addTo(detailMarkersLayer);

                details = locationDetails["Nga Sơn"];
                popupContent = createPopupContent(details);
                L.marker([19.983, 105.967]).bindPopup(popupContent).addTo(detailMarkersLayer);

                details = locationDetails["Hoằng Hóa"];
                popupContent = createPopupContent(details);
                L.marker([19.85, 105.86]).bindPopup(popupContent).addTo(detailMarkersLayer);
            }
          })
          .catch(e => console.error("Lỗi tải bản đồ chi tiết:", e));

        closeButton.classList.remove('hidden');
      });
      cityMarkers.push(marker);
    });

    closeButton.addEventListener('click', () => {
      detailMarkersLayer.clearLayers();
      if (detailedLayer) map.removeLayer(detailedLayer);
      detailedLayer = null;

      cityMarkers.forEach(m => m.addTo(map));
      if (allProvincesLayer) allProvincesLayer.addTo(map);
      
      map.fitBounds(allProvincesLayer.getBounds());
      map.setMaxBounds(allProvincesLayer.getBounds());
      closeButton.classList.add('hidden');
    });
  </script>
</body>
</html>
